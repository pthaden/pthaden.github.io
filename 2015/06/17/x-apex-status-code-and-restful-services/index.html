<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-APEX-STATUS-CODE and APEX RESTful Services &mdash; Like A House Afire</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/assets/main.css">
    <link rel="shortcut icon" href="/favicon.ico?v=2" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.gif?v=2" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/Avatar.png"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="Like A House Afire" />
    <meta name="title" content="X-APEX-STATUS-CODE and APEX RESTful Services ">
    <link rel="canonical" href="http://www.likeahouseafire.com/2015/06/17/x-apex-status-code-and-restful-services/">
    <link rel="alternate" title="" type="application/json" href="http://www.likeahouseafire.com//feed.json" />
     
    <link rel="author" href="https://plus.google.com/111502137181170252947">       
    <meta property="og:title" content="X-APEX-STATUS-CODE and APEX RESTful Services "/>
    <meta property="og:url" content="http://www.likeahouseafire.com/2015/06/17/x-apex-status-code-and-restful-services/"/>
    
    
    <meta property="og:description" content="Sending back the HTTP Status Code you want to send"/>
    <meta name="description" content="Sending back the HTTP Status Code you want to send"/>
    
    <meta property="og:site_name" content="Like A House Afire">     
</head>
<body>
    
<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
                <img src="/images/Avatar.png" alt="Inc">
            </a>
            <a href="/" class="home">Blog</a>
            
            <a href="/about/">About</a>
        </nav>
        
    </header>
</section>


<article>

    <div class="container">
        <header>
            <div class="meta">
                By <address><a rel="author" href="" title="Paul Thaden" target="_blank">Paul Thaden</a></address> &mdash;
                <time pubdate datetime="2015-17-June" title="June 17, 2015">June 17, 2015</time>
            </div>
            <h1 class="title">X-APEX-STATUS-CODE and APEX RESTful Services</h1>
            </header>

        <section>
            <p>When using the <a href="http://www.oracle.com/technetwork/developer-tools/rest-data-services/documentation/listener-dev-guide-1979546.html">APEX RESTful Services</a> to develop endpoints, you can get pretty funky and create entire PL/SQL handlers for your RESTful endpoints. </p>

<p>This is especially useful for POSTs because you can pluck off inbound HTTP headers and stuff them into parameters in the RESTful handler, and then reference those parameters as bind variables in your PL/SQL. You can also send back bind variables in the outbound response, either as headers or in the body.</p>

<p>We ran into an issue where we were using the header values to insert into a table. The problem came when a row already existed in the table: the SQL insert would fail, but the RESTful handler didn’t handle it gracefully or pass on the error. Instead, it would throw a <code>500</code> status code and send back HTML generated by the RESTful listener. The HTML was generic and not very helpful, and we couldn’t put the RESTful listener into debug mode because we were running on DBSchema Service (and who wants to send debug responses to consumers of their RESTful APIs, anyway?).</p>

<div class="full zoomable"><img src="/images/20150617/500error.png" /></div>

<p>Instead, we wanted to send an HTTP status code that more accurately reflected the error on the insert, and perhaps even included a description in the message body. Turns out you can explicitly set the HTTP status code on the RESTful handler’s response using the <a href="https://docs.oracle.com/cd/E21611_01/doc.11/e21058/rest_api.htm#AELIG7136">documentation for X-APEX-STATUS-CODE</a>. </p>

<p>We were able to hack up the PL/SQL for our POST handler and get it to trap for the database constraint that was preventing duplicate rows with an <code>EXCEPTION</code> block. Now instead of a horrible HTML <code>500</code> error page, the service returns a nice <code>422</code> (seemed like the right error code for duplicate row) and it also returns a json text object for good measure:</p>

<div class="full zoomable"><img src="/images/20150617/422error.png" /></div>

<p>The trick was to flesh out the code for the handler into a proper pl/sql block. There’s also that special OUT parameter named X-APEX-STATUS-CODE that the APEX listener will put into the HTTP headers if you ask it real nice.</p>

<p>Here’s the code that did the trick:</p>

<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="cm">/* original code: </span>
<span class="cm">insert into im_favorites (server, engagement_name) values (:server_name, :engagement) */</span>
 
<span class="cm">/* fancy new code from here: http://www.oracle.com/technetwork/database/database-cloud/public/restful-wp-1844130.pdf */</span>
 
<span class="k">DECLARE</span>
<span class="c1">--setup variables to hold the post-process queries from the database</span>
 <span class="n">v_en</span> <span class="n">im_favorites</span><span class="p">.</span><span class="n">engagement_name</span><span class="o">%</span><span class="k">type</span><span class="p">;</span>
 <span class="n">v_existing_en</span> <span class="n">im_favorites</span><span class="p">.</span><span class="n">engagement_name</span><span class="o">%</span><span class="k">type</span><span class="p">;</span>
 
<span class="k">BEGIN</span>
<span class="c1">--regular insert from the parameters passed in on URL and header</span>
 <span class="k">INSERT</span> <span class="k">into</span> <span class="n">im_favorites</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">engagement_name</span><span class="p">)</span>
 <span class="k">values</span><span class="p">(:</span><span class="k">server_name</span><span class="p">,</span> <span class="p">:</span><span class="n">engagement</span><span class="p">)</span>
 <span class="n">returning</span> <span class="n">engagement_name</span> <span class="k">into</span> <span class="n">v_en</span><span class="p">;</span>
<span class="c1">--set the http status code</span>
 <span class="p">:</span><span class="n">status</span> <span class="p">:</span><span class="o">=</span> <span class="mi">201</span><span class="p">;</span>
<span class="c1">--put the database&#39;s new data into the returned json</span>
 <span class="p">:</span><span class="n">engagement_response</span> <span class="p">:</span><span class="o">=</span> <span class="n">v_en</span><span class="p">;</span>
 <span class="k">commit</span><span class="p">;</span>
 
<span class="k">EXCEPTION</span>
<span class="c1">--if there&#39;s a row already in the database, will throw a dup_val_on_index exception</span>
    <span class="k">when</span> <span class="n">dup_val_on_index</span> <span class="k">then</span>
      <span class="k">select</span> <span class="n">engagement_name</span>
        <span class="k">into</span> <span class="n">v_existing_en</span>
        <span class="k">from</span> <span class="n">im_favorites</span>
        <span class="k">where</span> <span class="n">server</span> <span class="o">=</span> <span class="p">:</span><span class="k">server_name</span><span class="p">;</span>
<span class="c1">--set the http status code to 422</span>
      <span class="p">:</span><span class="n">status</span> <span class="p">:</span><span class="o">=</span> <span class="mi">422</span><span class="p">;</span>
<span class="c1">--create a descriptive message to put in the returned json</span>
      <span class="p">:</span><span class="n">engagement_response</span> <span class="p">:</span><span class="o">=</span> <span class="s1">&#39;Attempted to enter: &#39;&#39;&#39;</span> <span class="o">||</span> <span class="p">:</span><span class="n">engagement</span> <span class="o">||</span> <span class="s1">&#39;&#39;&#39;.  Already exists as: &#39;&#39;&#39;</span> <span class="o">||</span> <span class="n">v_existing_en</span> <span class="o">||</span> <span class="s1">&#39;&#39;&#39; for server: &#39;</span> <span class="o">||</span> <span class="p">:</span><span class="k">server_name</span><span class="p">;</span>
 
<span class="k">END</span><span class="p">;</span></code></pre></div>

<p>And for good measure, here’s the parameters as defined for the RESTful handler:</p>

<div class="full zoomable"><img width="100%" src="/images/20150617/parameters.png" /></div>


            
            <div class="tags">
<a href="/tag/APEX">APEX</a>
<a href="/tag/REST">REST</a></div>

        
            

            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="X-APEX-STATUS-CODE and APEX RESTful Services" data-related="pthaden">Tweet</a>
    </div>
    
    
    <div>
        <div class="fb-like" data-width="150" data-layout="button_count" data-action="like" data-show-faces="true" data-send="false"></div>
    </div>
    
    
    <div>
        <div class="g-plusone" data-size="medium"></div>
    </div>
    
    
    
    <div>
        <a href="http://news.ycombinator.com/submit" class="hn-share-button">Vote on HN</a>
    </div>
    
</div>


            <div id="post-nav" class="clearfix">
                 
                    <a class="previous-post" href="/2015/06/04/how-do-you-add-a-play-pause-bar-in-Swift/">&laquo; How do you add a play/pause bar in Swift?</a> 
                 
                 
                    <a class="next-post" href="/2015/11/23/learning-knockout-js/">Learning Knockout.js &raquo;</a> 
                 
            </div>

        </section>

        <footer>
            <address>
               <img src="/images/Avatar.png">
                <p>Written by <strong><a rel="author" href="https://twitter.com/pthaden" title="" target="_blank">Paul Thaden</a></strong><br>
                <span class="muted">Dad to twin boys and twin girls; Retooling in my 40s around front-end dev and JavaScript; Oracle CX Apps Sales Consultant; all-around guy</span>
                </p>
            </address>

        </footer>


        
        <section>
            <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'likeahouseafire'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
        </section>
        
    </div>

</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2018 
        
        <nav>
            <a href="http://likeahouseafire.com/">Like A House Afire</a> &middot;
            <a href="/">Blog</a> &middot;
            
            <a href="/about/">About</a>
        </nav>
        
        <nav class="social">
            
            <a href="https://twitter.com/pthaden" title="Follow on Twitter" target="_blank"><i class="icon icon-twitter black"></i></a>
            
                
            <a href="/feed.xml" title="RSS Feed">
                <i class="icon icon-rss black"></i>
            </a>
        </nav>
        <p>Incorporated theme by <a href="https://sendtoinc.com">Inc</a></p>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=253595308025739";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>
<script>
    (function(d, t) {
        var g = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        g.src = '//hnbutton.appspot.com/static/hn.min.js';
        s.parentNode.insertBefore(g, s);
    }(document, 'script'));
</script>

  <!--google analytics tracking code here-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-45292037-1', 'likeahouseafire.com');
  ga('send', 'pageview');

</script>



</body>
</html>
